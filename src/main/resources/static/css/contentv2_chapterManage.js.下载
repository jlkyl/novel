/*
 * jQuery Form Plugin
 * version: 3.51.0-2014.06.20
 * Requires jQuery v1.5 or later
 * Copyright (c) 2014 M. Alsup
 * Examples and documentation at: http://malsup.com/jquery/form/
 * Project repository: https://github.com/malsup/form
 * Dual licensed under the MIT and GPL licenses.
 * https://github.com/malsup/form#copyright-and-license
 */
!function (e) {
    "use strict";
    "function" == typeof define && define.amd ? define(["jquery"], e) : e("undefined" != typeof jQuery ? jQuery : window.Zepto)
}(function (e) {
    "use strict";

    function t(t) {
        var r = t.data;
        t.isDefaultPrevented() || (t.preventDefault(), e(t.target).ajaxSubmit(r))
    }

    function r(t) {
        var r = t.target, a = e(r);
        if (!a.is("[type=submit],[type=image]")) {
            var n = a.closest("[type=submit]");
            if (0 === n.length) return;
            r = n[0]
        }
        var i = this;
        if (i.clk = r, "image" == r.type) if (void 0 !== t.offsetX) i.clk_x = t.offsetX, i.clk_y = t.offsetY; else if ("function" == typeof e.fn.offset) {
            var o = a.offset();
            i.clk_x = t.pageX - o.left, i.clk_y = t.pageY - o.top
        } else i.clk_x = t.pageX - r.offsetLeft, i.clk_y = t.pageY - r.offsetTop;
        setTimeout(function () {
            i.clk = i.clk_x = i.clk_y = null
        }, 100)
    }

    function a() {
        if (e.fn.ajaxSubmit.debug) {
            var t = "[jquery.form] " + Array.prototype.join.call(arguments, "");
            window.console && window.console.log ? window.console.log(t) : window.opera && window.opera.postError && window.opera.postError(t)
        }
    }

    var n = {};
    n.fileapi = void 0 !== e("<input type='file'/>").get(0).files, n.formdata = void 0 !== window.FormData;
    var i = !!e.fn.prop;
    e.fn.attr2 = function () {
        if (!i) return this.attr.apply(this, arguments);
        var e = this.prop.apply(this, arguments);
        return e && e.jquery || "string" == typeof e ? e : this.attr.apply(this, arguments)
    }, e.fn.ajaxSubmit = function (t) {
        function r(r) {
            var a, n, i = e.param(r, t.traditional).split("&"), o = i.length, s = [];
            for (a = 0; o > a; a++) i[a] = i[a].replace(/\+/g, " "), n = i[a].split("="), s.push([decodeURIComponent(n[0]), decodeURIComponent(n[1])]);
            return s
        }

        function o(a) {
            for (var n = new FormData, i = 0; i < a.length; i++) n.append(a[i].name, a[i].value);
            if (t.extraData) {
                var o = r(t.extraData);
                for (i = 0; i < o.length; i++) o[i] && n.append(o[i][0], o[i][1])
            }
            t.data = null;
            var s = e.extend(!0, {}, e.ajaxSettings, t, {
                contentType: !1,
                processData: !1,
                cache: !1,
                type: u || "POST"
            });
            t.uploadProgress && (s.xhr = function () {
                var r = e.ajaxSettings.xhr();
                return r.upload && r.upload.addEventListener("progress", function (e) {
                    var r = 0, a = e.loaded || e.position, n = e.total;
                    e.lengthComputable && (r = Math.ceil(a / n * 100)), t.uploadProgress(e, a, n, r)
                }, !1), r
            }), s.data = null;
            var c = s.beforeSend;
            return s.beforeSend = function (e, r) {
                r.data = t.formData ? t.formData : n, c && c.call(this, e, r)
            }, e.ajax(s)
        }

        function s(r) {
            function n(e) {
                var t = null;
                try {
                    e.contentWindow && (t = e.contentWindow.document)
                } catch (r) {
                    a("cannot get iframe.contentWindow document: " + r)
                }
                if (t) return t;
                try {
                    t = e.contentDocument ? e.contentDocument : e.document
                } catch (r) {
                    a("cannot get iframe.contentDocument: " + r), t = e.document
                }
                return t
            }

            function o() {
                function t() {
                    try {
                        var e = n(g).readyState;
                        a("state = " + e), e && "uninitialized" == e.toLowerCase() && setTimeout(t, 50)
                    } catch (r) {
                        a("Server abort: ", r, " (", r.name, ")"), s(k), j && clearTimeout(j), j = void 0
                    }
                }

                var r = f.attr2("target"), i = f.attr2("action"), o = "multipart/form-data",
                    c = f.attr("enctype") || f.attr("encoding") || o;
                w.setAttribute("target", p), (!u || /post/i.test(u)) && w.setAttribute("method", "POST"), i != m.url && w.setAttribute("action", m.url), m.skipEncodingOverride || u && !/post/i.test(u) || f.attr({
                    encoding: "multipart/form-data",
                    enctype: "multipart/form-data"
                }), m.timeout && (j = setTimeout(function () {
                    T = !0, s(D)
                }, m.timeout));
                var l = [];
                try {
                    if (m.extraData) for (var d in m.extraData) m.extraData.hasOwnProperty(d) && l.push(e.isPlainObject(m.extraData[d]) && m.extraData[d].hasOwnProperty("name") && m.extraData[d].hasOwnProperty("value") ? e('<input type="hidden" name="' + m.extraData[d].name + '">').val(m.extraData[d].value).appendTo(w)[0] : e('<input type="hidden" name="' + d + '">').val(m.extraData[d]).appendTo(w)[0]);
                    m.iframeTarget || v.appendTo("body"), g.attachEvent ? g.attachEvent("onload", s) : g.addEventListener("load", s, !1), setTimeout(t, 15);
                    try {
                        w.submit()
                    } catch (h) {
                        var x = document.createElement("form").submit;
                        x.apply(w)
                    }
                } finally {
                    w.setAttribute("action", i), w.setAttribute("enctype", c), r ? w.setAttribute("target", r) : f.removeAttr("target"), e(l).remove()
                }
            }

            function s(t) {
                if (!x.aborted && !F) {
                    if (M = n(g), M || (a("cannot access response document"), t = k), t === D && x) return x.abort("timeout"), void S.reject(x, "timeout");
                    if (t == k && x) return x.abort("server abort"), void S.reject(x, "error", "server abort");
                    if (M && M.location.href != m.iframeSrc || T) {
                        g.detachEvent ? g.detachEvent("onload", s) : g.removeEventListener("load", s, !1);
                        var r, i = "success";
                        try {
                            if (T) throw"timeout";
                            var o = "xml" == m.dataType || M.XMLDocument || e.isXMLDoc(M);
                            if (a("isXml=" + o), !o && window.opera && (null === M.body || !M.body.innerHTML) && --O) return a("requeing onLoad callback, DOM not available"), void setTimeout(s, 250);
                            var u = M.body ? M.body : M.documentElement;
                            x.responseText = u ? u.innerHTML : null, x.responseXML = M.XMLDocument ? M.XMLDocument : M, o && (m.dataType = "xml"), x.getResponseHeader = function (e) {
                                var t = {"content-type": m.dataType};
                                return t[e.toLowerCase()]
                            }, u && (x.status = Number(u.getAttribute("status")) || x.status, x.statusText = u.getAttribute("statusText") || x.statusText);
                            var c = (m.dataType || "").toLowerCase(), l = /(json|script|text)/.test(c);
                            if (l || m.textarea) {
                                var f = M.getElementsByTagName("textarea")[0];
                                if (f) x.responseText = f.value, x.status = Number(f.getAttribute("status")) || x.status, x.statusText = f.getAttribute("statusText") || x.statusText; else if (l) {
                                    var p = M.getElementsByTagName("pre")[0], h = M.getElementsByTagName("body")[0];
                                    p ? x.responseText = p.textContent ? p.textContent : p.innerText : h && (x.responseText = h.textContent ? h.textContent : h.innerText)
                                }
                            } else "xml" == c && !x.responseXML && x.responseText && (x.responseXML = X(x.responseText));
                            try {
                                E = _(x, c, m)
                            } catch (y) {
                                i = "parsererror", x.error = r = y || i
                            }
                        } catch (y) {
                            a("error caught: ", y), i = "error", x.error = r = y || i
                        }
                        x.aborted && (a("upload aborted"), i = null), x.status && (i = x.status >= 200 && x.status < 300 || 304 === x.status ? "success" : "error"), "success" === i ? (m.success && m.success.call(m.context, E, "success", x), S.resolve(x.responseText, "success", x), d && e.event.trigger("ajaxSuccess", [x, m])) : i && (void 0 === r && (r = x.statusText), m.error && m.error.call(m.context, x, i, r), S.reject(x, "error", r), d && e.event.trigger("ajaxError", [x, m, r])), d && e.event.trigger("ajaxComplete", [x, m]), d && !--e.active && e.event.trigger("ajaxStop"), m.complete && m.complete.call(m.context, x, i), F = !0, m.timeout && clearTimeout(j), setTimeout(function () {
                            m.iframeTarget ? v.attr("src", m.iframeSrc) : v.remove(), x.responseXML = null
                        }, 100)
                    }
                }
            }

            var c, l, m, d, p, v, g, x, y, b, T, j, w = f[0], S = e.Deferred();
            if (S.abort = function (e) {
                    x.abort(e)
                }, r) for (l = 0; l < h.length; l++) c = e(h[l]), i ? c.prop("disabled", !1) : c.removeAttr("disabled");
            if (m = e.extend(!0, {}, e.ajaxSettings, t), m.context = m.context || m, p = "jqFormIO" + (new Date).getTime(), m.iframeTarget ? (v = e(m.iframeTarget), b = v.attr2("name"), b ? p = b : v.attr2("name", p)) : (v = e('<iframe name="' + p + '" src="' + m.iframeSrc + '" />'), v.css({
                    position: "absolute",
                    top: "-1000px",
                    left: "-1000px"
                })), g = v[0], x = {
                    aborted: 0,
                    responseText: null,
                    responseXML: null,
                    status: 0,
                    statusText: "n/a",
                    getAllResponseHeaders: function () {
                    },
                    getResponseHeader: function () {
                    },
                    setRequestHeader: function () {
                    },
                    abort: function (t) {
                        var r = "timeout" === t ? "timeout" : "aborted";
                        a("aborting upload... " + r), this.aborted = 1;
                        try {
                            g.contentWindow.document.execCommand && g.contentWindow.document.execCommand("Stop")
                        } catch (n) {
                        }
                        v.attr("src", m.iframeSrc), x.error = r, m.error && m.error.call(m.context, x, r, t), d && e.event.trigger("ajaxError", [x, m, r]), m.complete && m.complete.call(m.context, x, r)
                    }
                }, d = m.global, d && 0 === e.active++ && e.event.trigger("ajaxStart"), d && e.event.trigger("ajaxSend", [x, m]), m.beforeSend && m.beforeSend.call(m.context, x, m) === !1) return m.global && e.active--, S.reject(), S;
            if (x.aborted) return S.reject(), S;
            y = w.clk, y && (b = y.name, b && !y.disabled && (m.extraData = m.extraData || {}, m.extraData[b] = y.value, "image" == y.type && (m.extraData[b + ".x"] = w.clk_x, m.extraData[b + ".y"] = w.clk_y)));
            var D = 1, k = 2, A = e("meta[name=csrf-token]").attr("content"),
                L = e("meta[name=csrf-param]").attr("content");
            L && A && (m.extraData = m.extraData || {}, m.extraData[L] = A), m.forceSync ? o() : setTimeout(o, 10);
            var E, M, F, O = 50, X = e.parseXML || function (e, t) {
                return window.ActiveXObject ? (t = new ActiveXObject("Microsoft.XMLDOM"), t.async = "false", t.loadXML(e)) : t = (new DOMParser).parseFromString(e, "text/xml"), t && t.documentElement && "parsererror" != t.documentElement.nodeName ? t : null
            }, C = e.parseJSON || function (e) {
                return window.eval("(" + e + ")")
            }, _ = function (t, r, a) {
                var n = t.getResponseHeader("content-type") || "", i = "xml" === r || !r && n.indexOf("xml") >= 0,
                    o = i ? t.responseXML : t.responseText;
                return i && "parsererror" === o.documentElement.nodeName && e.error && e.error("parsererror"), a && a.dataFilter && (o = a.dataFilter(o, r)), "string" == typeof o && ("json" === r || !r && n.indexOf("json") >= 0 ? o = C(o) : ("script" === r || !r && n.indexOf("javascript") >= 0) && e.globalEval(o)), o
            };
            return S
        }

        if (!this.length) return a("ajaxSubmit: skipping submit process - no element selected"), this;
        var u, c, l, f = this;
        "function" == typeof t ? t = {success: t} : void 0 === t && (t = {}), u = t.type || this.attr2("method"), c = t.url || this.attr2("action"), l = "string" == typeof c ? e.trim(c) : "", l = l || window.location.href || "", l && (l = (l.match(/^([^#]+)/) || [])[1]), t = e.extend(!0, {
            url: l,
            success: e.ajaxSettings.success,
            type: u || e.ajaxSettings.type,
            iframeSrc: /^https/i.test(window.location.href || "") ? "javascript:false" : "about:blank"
        }, t);
        var m = {};
        if (this.trigger("form-pre-serialize", [this, t, m]), m.veto) return a("ajaxSubmit: submit vetoed via form-pre-serialize trigger"), this;
        if (t.beforeSerialize && t.beforeSerialize(this, t) === !1) return a("ajaxSubmit: submit aborted via beforeSerialize callback"), this;
        var d = t.traditional;
        void 0 === d && (d = e.ajaxSettings.traditional);
        var p, h = [], v = this.formToArray(t.semantic, h);
        if (t.data && (t.extraData = t.data, p = e.param(t.data, d)), t.beforeSubmit && t.beforeSubmit(v, this, t) === !1) return a("ajaxSubmit: submit aborted via beforeSubmit callback"), this;
        if (this.trigger("form-submit-validate", [v, this, t, m]), m.veto) return a("ajaxSubmit: submit vetoed via form-submit-validate trigger"), this;
        var g = e.param(v, d);
        p && (g = g ? g + "&" + p : p), "GET" == t.type.toUpperCase() ? (t.url += (t.url.indexOf("?") >= 0 ? "&" : "?") + g, t.data = null) : t.data = g;
        var x = [];
        if (t.resetForm && x.push(function () {
                f.resetForm()
            }), t.clearForm && x.push(function () {
                f.clearForm(t.includeHidden)
            }), !t.dataType && t.target) {
            var y = t.success || function () {
            };
            x.push(function (r) {
                var a = t.replaceTarget ? "replaceWith" : "html";
                e(t.target)[a](r).each(y, arguments)
            })
        } else t.success && x.push(t.success);
        if (t.success = function (e, r, a) {
                for (var n = t.context || this, i = 0, o = x.length; o > i; i++) x[i].apply(n, [e, r, a || f, f])
            }, t.error) {
            var b = t.error;
            t.error = function (e, r, a) {
                var n = t.context || this;
                b.apply(n, [e, r, a, f])
            }
        }
        if (t.complete) {
            var T = t.complete;
            t.complete = function (e, r) {
                var a = t.context || this;
                T.apply(a, [e, r, f])
            }
        }
        var j = e("input[type=file]:enabled", this).filter(function () {
                return "" !== e(this).val()
            }), w = j.length > 0, S = "multipart/form-data", D = f.attr("enctype") == S || f.attr("encoding") == S,
            k = n.fileapi && n.formdata;
        a("fileAPI :" + k);
        var A, L = (w || D) && !k;
        t.iframe !== !1 && (t.iframe || L) ? t.closeKeepAlive ? e.get(t.closeKeepAlive, function () {
            A = s(v)
        }) : A = s(v) : A = (w || D) && k ? o(v) : e.ajax(t), f.removeData("jqxhr").data("jqxhr", A);
        for (var E = 0; E < h.length; E++) h[E] = null;
        return this.trigger("form-submit-notify", [this, t]), this
    }, e.fn.ajaxForm = function (n) {
        if (n = n || {}, n.delegation = n.delegation && e.isFunction(e.fn.on), !n.delegation && 0 === this.length) {
            var i = {s: this.selector, c: this.context};
            return !e.isReady && i.s ? (a("DOM not ready, queuing ajaxForm"), e(function () {
                e(i.s, i.c).ajaxForm(n)
            }), this) : (a("terminating; zero elements found by selector" + (e.isReady ? "" : " (DOM not ready)")), this)
        }
        return n.delegation ? (e(document).off("submit.form-plugin", this.selector, t).off("click.form-plugin", this.selector, r).on("submit.form-plugin", this.selector, n, t).on("click.form-plugin", this.selector, n, r), this) : this.ajaxFormUnbind().bind("submit.form-plugin", n, t).bind("click.form-plugin", n, r)
    }, e.fn.ajaxFormUnbind = function () {
        return this.unbind("submit.form-plugin click.form-plugin")
    }, e.fn.formToArray = function (t, r) {
        var a = [];
        if (0 === this.length) return a;
        var i, o = this[0], s = this.attr("id"), u = t ? o.getElementsByTagName("*") : o.elements;
        if (u && !/MSIE [678]/.test(navigator.userAgent) && (u = e(u).get()), s && (i = e(':input[form="' + s + '"]').get(), i.length && (u = (u || []).concat(i))), !u || !u.length) return a;
        var c, l, f, m, d, p, h;
        for (c = 0, p = u.length; p > c; c++) if (d = u[c], f = d.name, f && !d.disabled) if (t && o.clk && "image" == d.type) o.clk == d && (a.push({
            name: f,
            value: e(d).val(),
            type: d.type
        }), a.push({name: f + ".x", value: o.clk_x}, {
            name: f + ".y",
            value: o.clk_y
        })); else if (m = e.fieldValue(d, !0), m && m.constructor == Array) for (r && r.push(d), l = 0, h = m.length; h > l; l++) a.push({
            name: f,
            value: m[l]
        }); else if (n.fileapi && "file" == d.type) {
            r && r.push(d);
            var v = d.files;
            if (v.length) for (l = 0; l < v.length; l++) a.push({
                name: f,
                value: v[l],
                type: d.type
            }); else a.push({name: f, value: "", type: d.type})
        } else null !== m && "undefined" != typeof m && (r && r.push(d), a.push({
            name: f,
            value: m,
            type: d.type,
            required: d.required
        }));
        if (!t && o.clk) {
            var g = e(o.clk), x = g[0];
            f = x.name, f && !x.disabled && "image" == x.type && (a.push({
                name: f,
                value: g.val()
            }), a.push({name: f + ".x", value: o.clk_x}, {name: f + ".y", value: o.clk_y}))
        }
        return a
    }, e.fn.formSerialize = function (t) {
        return e.param(this.formToArray(t))
    }, e.fn.fieldSerialize = function (t) {
        var r = [];
        return this.each(function () {
            var a = this.name;
            if (a) {
                var n = e.fieldValue(this, t);
                if (n && n.constructor == Array) for (var i = 0, o = n.length; o > i; i++) r.push({
                    name: a,
                    value: n[i]
                }); else null !== n && "undefined" != typeof n && r.push({name: this.name, value: n})
            }
        }), e.param(r)
    }, e.fn.fieldValue = function (t) {
        for (var r = [], a = 0, n = this.length; n > a; a++) {
            var i = this[a], o = e.fieldValue(i, t);
            null === o || "undefined" == typeof o || o.constructor == Array && !o.length || (o.constructor == Array ? e.merge(r, o) : r.push(o))
        }
        return r
    }, e.fieldValue = function (t, r) {
        var a = t.name, n = t.type, i = t.tagName.toLowerCase();
        if (void 0 === r && (r = !0), r && (!a || t.disabled || "reset" == n || "button" == n || ("checkbox" == n || "radio" == n) && !t.checked || ("submit" == n || "image" == n) && t.form && t.form.clk != t || "select" == i && -1 == t.selectedIndex)) return null;
        if ("select" == i) {
            var o = t.selectedIndex;
            if (0 > o) return null;
            for (var s = [], u = t.options, c = "select-one" == n, l = c ? o + 1 : u.length, f = c ? o : 0; l > f; f++) {
                var m = u[f];
                if (m.selected) {
                    var d = m.value;
                    if (d || (d = m.attributes && m.attributes.value && !m.attributes.value.specified ? m.text : m.value), c) return d;
                    s.push(d)
                }
            }
            return s
        }
        return e(t).val()
    }, e.fn.clearForm = function (t) {
        return this.each(function () {
            e("input,select,textarea", this).clearFields(t)
        })
    }, e.fn.clearFields = e.fn.clearInputs = function (t) {
        var r = /^(?:color|date|datetime|email|month|number|password|range|search|tel|text|time|url|week)$/i;
        return this.each(function () {
            var a = this.type, n = this.tagName.toLowerCase();
            r.test(a) || "textarea" == n ? this.value = "" : "checkbox" == a || "radio" == a ? this.checked = !1 : "select" == n ? this.selectedIndex = -1 : "file" == a ? /MSIE/.test(navigator.userAgent) ? e(this).replaceWith(e(this).clone(!0)) : e(this).val("") : t && (t === !0 && /hidden/.test(a) || "string" == typeof t && e(this).is(t)) && (this.value = "")
        })
    }, e.fn.resetForm = function () {
        return this.each(function () {
            ("function" == typeof this.reset || "object" == typeof this.reset && !this.reset.nodeType) && this.reset()
        })
    }, e.fn.enable = function (e) {
        return void 0 === e && (e = !0), this.each(function () {
            this.disabled = !e
        })
    }, e.fn.selected = function (t) {
        return void 0 === t && (t = !0), this.each(function () {
            var r = this.type;
            if ("checkbox" == r || "radio" == r) this.checked = t; else if ("option" == this.tagName.toLowerCase()) {
                var a = e(this).parent("select");
                t && a[0] && "select-one" == a[0].type && a.find("option").selected(!1), this.selected = t
            }
        })
    }, e.fn.ajaxSubmit.debug = !1
});
/* Copyright (c) 2011 Piotr Rochala (http://rocha.la)
 * Dual licensed under the MIT (http://www.opensource.org/licenses/mit-license.php)
 * and GPL (http://www.opensource.org/licenses/gpl-license.php) licenses.
 *
 * Version: 1.3.3
 *
 */
(function (e) {
    e.fn.extend({
        slimScroll: function (g) {
            var a = e.extend({
                width: "auto",
                height: "250px",
                size: "7px",
                color: "#ccc",
                position: "right",
                distance: "1px",
                start: "top",
                opacity: 1,
                alwaysVisible: !1,
                disableFadeOut: !1,
                railVisible: !1,
                railColor: "#EEE",
                railOpacity: 1,
                railDraggable: !0,
                railClass: "slimScrollRail",
                barClass: "slimScrollBar",
                wrapperClass: "slimScrollDiv",
                allowPageScroll: !1,
                wheelStep: 20,
                touchScrollStep: 200,
                borderRadius: "7px",
                railBorderRadius: "7px"
            }, g);
            this.each(function () {
                function u(d) {
                    if (r) {
                        d = d || window.event;
                        var c = 0;
                        d.wheelDelta && (c = -d.wheelDelta / 120);
                        d.detail && (c = d.detail / 3);
                        e(d.target || d.srcTarget || d.srcElement).closest("." + a.wrapperClass).is(b.parent()) && m(c, !0);
                        d.preventDefault && !k && d.preventDefault();
                        k || (d.returnValue = !1)
                    }
                }

                function m(d, e, g) {
                    k = !1;
                    var f = d, h = b.outerHeight() - c.outerHeight();
                    e && (f = parseInt(c.css("top")) + d * parseInt(a.wheelStep) / 100 * c.outerHeight(), f = Math.min(Math.max(f, 0), h), f = 0 < d ? Math.ceil(f) : Math.floor(f), c.css({top: f + "px"}));
                    l = parseInt(c.css("top")) / (b.outerHeight() - c.outerHeight());
                    f = l * (b[0].scrollHeight - b.outerHeight());
                    g && (f = d, d = f / b[0].scrollHeight * b.outerHeight(), d = Math.min(Math.max(d, 0), h), c.css({top: d + "px"}));
                    b.scrollTop(f);
                    b.trigger("slimscrolling", ~~f);
                    v();
                    p()
                }

                function C() {
                    window.addEventListener ? (this.addEventListener("DOMMouseScroll", u, !1), this.addEventListener("mousewheel", u, !1)) : document.attachEvent("onmousewheel", u)
                }

                function w() {
                    s = Math.max(b.outerHeight() / b[0].scrollHeight * b.outerHeight(), 30);
                    c.css({height: s + "px"});
                    var a = s == b.outerHeight() ? "none" : "block";
                    c.css({display: a})
                }

                function v() {
                    w();
                    clearTimeout(A);
                    l == ~~l ? (k = a.allowPageScroll, B != l && b.trigger("slimscroll", 0 == ~~l ? "top" : "bottom")) : k = !1;
                    B = l;
                    s >= b.outerHeight() ? k = !0 : (c.stop(!0, !0).fadeIn("fast"), a.railVisible && h.stop(!0, !0).fadeIn("fast"))
                }

                function p() {
                    a.alwaysVisible || (A = setTimeout(function () {
                        a.disableFadeOut && r || x || y || (c.fadeOut("slow"), h.fadeOut("slow"))
                    }, 1E3))
                }

                var r, x, y, A, z, s, l, B, k = !1, b = e(this);
                if (b.parent().hasClass(a.wrapperClass)) {
                    var n = b.scrollTop(), c = b.parent().find("." + a.barClass),
                        h = b.parent().find("." + a.railClass);
                    w();
                    if (e.isPlainObject(g)) {
                        if ("height" in g && "auto" == g.height) {
                            b.parent().css("height", "auto");
                            b.css("height", "auto");
                            var q = b.parent().parent().height();
                            b.parent().css("height", q);
                            b.css("height", q)
                        }
                        if ("scrollTo" in g) n = parseInt(a.scrollTo); else if ("scrollBy" in g) n += parseInt(a.scrollBy); else if ("destroy" in g) {
                            c.remove();
                            h.remove();
                            b.unwrap();
                            return
                        }
                        m(n, !1, !0)
                    }
                } else if (!(e.isPlainObject(g) && "destroy" in g)) {
                    a.height = "auto" == a.height ? b.parent().height() : a.height;
                    n = e("<div></div>").addClass(a.wrapperClass).css({
                        position: "relative",
                        overflow: "hidden",
                        width: a.width,
                        height: a.height
                    });
                    b.css({overflow: "hidden", width: a.width, height: a.height});
                    var h = e("<div></div>").addClass(a.railClass).css({
                        width: a.size,
                        height: "100%",
                        position: "absolute",
                        top: 0,
                        display: a.alwaysVisible && a.railVisible ? "block" : "none",
                        "border-radius": a.railBorderRadius,
                        background: a.railColor,
                        opacity: a.railOpacity,
                        zIndex: 90
                    }), c = e("<div></div>").addClass(a.barClass).css({
                        background: a.color,
                        width: a.size,
                        position: "absolute",
                        top: 0,
                        opacity: a.opacity,
                        display: a.alwaysVisible ? "block" : "none",
                        "border-radius": a.borderRadius,
                        BorderRadius: a.borderRadius,
                        MozBorderRadius: a.borderRadius,
                        WebkitBorderRadius: a.borderRadius,
                        zIndex: 99
                    }), q = "right" == a.position ? {right: a.distance} : {left: a.distance};
                    h.css(q);
                    c.css(q);
                    b.wrap(n);
                    b.parent().append(c);
                    b.parent().append(h);
                    a.railDraggable && c.bind("mousedown", function (a) {
                        var b = e(document);
                        y = !0;
                        t = parseFloat(c.css("top"));
                        pageY = a.pageY;
                        b.bind("mousemove.slimscroll", function (a) {
                            currTop = t + a.pageY - pageY;
                            c.css("top", currTop);
                            m(0, c.position().top, !1)
                        });
                        b.bind("mouseup.slimscroll", function (a) {
                            y = !1;
                            p();
                            b.unbind(".slimscroll")
                        });
                        return !1
                    }).bind("selectstart.slimscroll", function (a) {
                        a.stopPropagation();
                        a.preventDefault();
                        return !1
                    });
                    h.hover(function () {
                        v()
                    }, function () {
                        p()
                    });
                    c.hover(function () {
                        x = !0
                    }, function () {
                        x = !1
                    });
                    b.hover(function () {
                        r = !0;
                        v();
                        p()
                    }, function () {
                        r = !1;
                        p()
                    });
                    b.bind("touchstart", function (a, b) {
                        a.originalEvent.touches.length && (z = a.originalEvent.touches[0].pageY)
                    });
                    b.bind("touchmove", function (b) {
                        k || b.originalEvent.preventDefault();
                        b.originalEvent.touches.length && (m((z - b.originalEvent.touches[0].pageY) / a.touchScrollStep, !0), z = b.originalEvent.touches[0].pageY)
                    });
                    w();
                    "bottom" === a.start ? (c.css({top: b.outerHeight() - c.outerHeight()}), m(0, !0)) : "top" !== a.start && (m(e(a.start).position().top, null, !0), a.alwaysVisible || c.hide());
                    C()
                }
            });
            return this
        }
    });
    e.fn.extend({slimscroll: e.fn.slimScroll})
})(jQuery);
(function ($) {
    $.fn.portamento = function (options) {
        var thisWindow = $(window);
        var thisDocument = $(document);
        $.fn.viewportOffset = function () {
            var win = $(window);
            var offset = $(this).offset();
            return {left: offset.left - win.scrollLeft(), top: offset.top - win.scrollTop()}
        };

        function positionFixedSupported() {
            var container = document.body;
            if (document.createElement && container && container.appendChild && container.removeChild) {
                var el = document.createElement("div");
                if (!el.getBoundingClientRect) {
                    return null
                }
                el.innerHTML = "x";
                el.style.cssText = "position:fixed;top:100px;";
                container.appendChild(el);
                var originalHeight = container.style.height, originalScrollTop = container.scrollTop;
                container.style.height = "3000px";
                container.scrollTop = 500;
                var elementTop = el.getBoundingClientRect().top;
                container.style.height = originalHeight;
                var isSupported = elementTop === 100;
                container.removeChild(el);
                container.scrollTop = originalScrollTop;
                return isSupported
            }
            return null
        }

        function getScrollerWidth() {
            var scr = null;
            var inn = null;
            var wNoScroll = 0;
            var wScroll = 0;
            scr = document.createElement("div");
            scr.style.position = "absolute";
            scr.style.top = "-1000px";
            scr.style.left = "-1000px";
            scr.style.width = "100px";
            scr.style.height = "50px";
            scr.style.overflow = "hidden";
            inn = document.createElement("div");
            inn.style.width = "100%";
            inn.style.height = "200px";
            scr.appendChild(inn);
            document.body.appendChild(scr);
            wNoScroll = inn.offsetWidth;
            scr.style.overflow = "auto";
            wScroll = inn.offsetWidth;
            document.body.removeChild(document.body.lastChild);
            return (wNoScroll - wScroll)
        }

        var opts = $.extend({}, $.fn.portamento.defaults, options);
        var panel = this;
        var wrapper = opts.wrapper;
        var gap = opts.gap;
        var disableWorkaround = opts.disableWorkaround;
        var fullyCapableBrowser = positionFixedSupported();
        if (panel.length != 1) {
            return this
        }
        if (!fullyCapableBrowser && disableWorkaround) {
            return this
        }
        panel.wrap('<div id="portamento_container" />');
        var float_container = $("#portamento_container");
        float_container.css({"min-height": panel.outerHeight(), width: panel.outerWidth()});
        var panelOffset = panel.offset().top;
        var panelMargin = parseFloat(panel.css("marginTop").replace(/auto/, 0));
        var realPanelOffset = panelOffset - panelMargin;
        var topScrollBoundary = realPanelOffset - gap;
        var wrapperPaddingFix = parseFloat(wrapper.css("paddingTop").replace(/auto/, 0));
        var containerMarginFix = parseFloat(float_container.css("marginTop").replace(/auto/, 0));
        var ieFix = 0;
        var isMSIE = /*@cc_on!@*/0;
        if (isMSIE) {
            ieFix = getScrollerWidth() + 4
        }
        thisWindow.bind("scroll.portamento", function () {
            if (thisWindow.height() > panel.outerHeight() && thisWindow.width() >= (thisDocument.width() - ieFix)) {
                var y = thisDocument.scrollTop();
                if (y >= (topScrollBoundary)) {
                    if ((panel.innerHeight() - wrapper.viewportOffset().top) - wrapperPaddingFix + gap >= wrapper.height()) {
                        if (panel.hasClass("fixed") || thisWindow.height() >= panel.outerHeight()) {
                            panel.removeClass("fixed");
                            panel.css("top", (wrapper.height() - panel.innerHeight()) + "px")
                        }
                    } else {
                        panel.addClass("fixed");
                        if (fullyCapableBrowser) {
                            panel.css("top", gap + "px")
                        } else {
                            panel.clearQueue();
                            panel.css("position", "absolute").animate({top: (0 - float_container.viewportOffset().top + gap)})
                        }
                    }
                } else {
                    panel.removeClass("fixed");
                    panel.css("top", "0")
                }
            } else {
                panel.removeClass("fixed")
            }
        });
        thisWindow.bind("resize.portamento", function () {
            if (thisWindow.height() <= panel.outerHeight() || thisWindow.width() < thisDocument.width()) {
                if (panel.hasClass("fixed")) {
                    panel.removeClass("fixed");
                    panel.css("top", "0")
                }
            } else {
                thisWindow.trigger("scroll.portamento")
            }
        });
        thisWindow.bind("orientationchange.portamento", function () {
            thisWindow.trigger("resize.portamento")
        });
        thisWindow.trigger("scroll.portamento");
        return this
    };
    $.fn.portamento.defaults = {wrapper: $("body"), gap: 10, disableWorkaround: false}
})(jQuery);
(function ($) {
    var _util = CS.util;
    var _nodes = {}, _autoHideTime = 1000, _autoHideTimeout = null;
    var _boxTpl = ['<div id="topTipBox" class="top-tipbox hidden">', '<p data-node="content"></p>', '</div>'].join('');

    function show(content, closeCallback) {
        if (!content) {
            return;
        }
        if (_autoHideTimeout) {
            clearTimeout(_autoHideTimeout);
        }
        _nodes.$box = $('#topTipBox');
        if (!_nodes.$box || _nodes.$box.length === 0) {
            $(document.body).append(_boxTpl);
            $(window).on('resize', function () {
                _util.throttle(setPosition);
            });
            _nodes.$box = $('#topTipBox');
        }
        _nodes.$content = _nodes.$box.find('[data-node="content"]');
        _nodes.$content.text(content);
        setPosition();
        _nodes.$box.fadeIn('fast');
        _autoHideTimeout = setTimeout(function () {
            hide(closeCallback);
        }, _autoHideTime);
    }

    function hide(closeCallback) {
        if (_autoHideTimeout) {
            clearTimeout(_autoHideTimeout);
        }
        _nodes.$box.fadeOut('slow', function () {
            if (typeof closeCallback === 'function') {
                closeCallback();
            }
        });
    }

    function setPosition() {
        var left = ($(window).width() - _nodes.$box.width()) / 2;
        _nodes.$box.css('left', left + 'px');
    }

    _util.initNameSpace("CS");
    CS.topTip = {'show': show, 'hide': hide, 'setPosition': setPosition};
})(jQuery);
(function ($) {
    var _util = CS.util, _dialog = CS.dialog;

    function show($fileBtn, $previewImg, configs) {
        if (!$fileBtn || $fileBtn.length === 0 || !$previewImg || $previewImg.length === 0) {
            return false;
        }
        var defaults = {
            'supportFileTypes': 'jpg',
            'fileTypeErrorTips': '这个图片的格式一定要是JPG',
            'imgMaxSize': 5120,
            'imgMaxSizeTips': '您上传的图片大于5MB'
        }, options = $.extend(true, {}, defaults, configs);
        var fileBtn = $fileBtn.get(0), reg = new RegExp('\\.(' + options.supportFileTypes + ')$', 'i');
        if (!reg.test($fileBtn.val())) {
            _dialog.alert(options.fileTypeErrorTips);
            $fileBtn.focus();
            return false;
        }
        if (fileBtn.files && fileBtn.files.length > 0) {
            var file = fileBtn.files[0];
            if (file.size >= options.imgMaxSize * 1024) {
                _dialog.alert(options.imgMaxSizeTips);
                $fileBtn.focus();
                return false;
            }
            var fileReader = new FileReader();
            fileReader.onload = function (e) {
                $previewImg.attr('src', e.target.result).show();
            };
            fileReader.readAsDataURL(file);
        }
        return true;
    }

    function showv2($fileBtn, $previewImg, configs) {
        if (!$fileBtn || $fileBtn.length === 0 || !$previewImg || $previewImg.length === 0 || $fileBtn.val() == '') {
            return false;
        }
        var defaults = {
            'supportFileTypes': 'jpg',
            'fileTypeErrorTips': '这个图片的格式一定要是JPG',
            'imgMaxSize': 5120,
            'imgMaxSizeTips': '您上传的图片大于5MB'
        }, options = $.extend(true, {}, defaults, configs);
        var fileBtn = $fileBtn.get(0), reg = new RegExp('\\.(' + options.supportFileTypes + ')$', 'i');
        if (!reg.test($fileBtn.val())) {
            _dialog.alert(options.fileTypeErrorTips);
            $fileBtn.focus();
            return false;
        }
        if (fileBtn.files && fileBtn.files.length > 0) {
            var file = fileBtn.files[0];
            if (file.size >= options.imgMaxSize * 1024) {
                _dialog.alert(options.imgMaxSizeTips);
                $fileBtn.focus();
                return false;
            }
            var fileReader = new FileReader();
            fileReader.onload = function (e) {
                $previewImg.attr('src', e.target.result).show();
            };
            fileReader.readAsDataURL(file);
        }
        return true;
    }

    _util.initNameSpace("CS");
    CS.localImg = {'show': show, 'showv2': showv2};
})(jQuery);
(function ($) {
    var _util = CS.util, _mask = CS.mask, _dialog = CS.dialog, _topTip = CS.topTip;
    var _params = {}, _isSubmitting = 0, _maskByCreateVolumePopup = null;
    var _ajaxUrls = {'submitVolume': '/Contentv2/Booksubmit/volumeManageSubmit.html'};
    var _createVolumePopupTpl = ['<div id="createVolumePopup" class="popupWrap w380 hidden">', '<a data-node="close" class="icon closePopup" href="javascript:" title="关闭"></a>', '<h3 data-node="volumeSort"></h3>', '<div class="popupBody p30">', '<div class="popupContent select">', '<p>分卷名称</p>', '<p class="mb20">', '<input data-node="volumeTitleInput" class="longInput" type="text" value="">', '</p>', '<p>分卷介绍</p>', '<textarea data-node="volumeDescInput"></textarea>', '</div>', '<div class="confirmBtn">', '<a data-node="confirm" class="button full" href="javascript:">确定</a>', '<div></div>', '</div>', '</div>', '</div>'].join('');

    function init(bookId, isVipNovel, newVolumeName) {
        _params.bookId = bookId || 0;
        _params.isVipNovel = isVipNovel || -1;
        _params.newVolumeName = newVolumeName || '新建分卷';
    }

    function _bindEventByCreateVolumePopup() {
        var $popup = $('#createVolumePopup');
        $popup.find('[data-node="close"]').on('click', function (event) {
            event.preventDefault();
            closeCreateVolumePopup();
        });
        $popup.find('[data-node="confirm"]').on('click', function (event) {
            event.preventDefault();
            submitVolume({
                'bookId': _params.bookId,
                'type': 'add',
                'isVip': _params.isVipNovel,
                'volumeName': $popup.find('[data-node="volumeTitleInput"]').val(),
                'volumeDesc': $popup.find('[data-node="volumeDescInput"]').val(),
                'alertType': 'alert',
                'successCallback': _refreshCurrentPage
            });
        });
    }

    function openCreateVolumePopup() {
        var $popup = $('#createVolumePopup');
        if ($popup.length === 0) {
            $(document.body).append(_createVolumePopupTpl);
            $popup = $('#createVolumePopup');
            _bindEventByCreateVolumePopup();
            _maskByCreateVolumePopup = new _mask($popup);
        }
        if (_maskByCreateVolumePopup) {
            $popup.find('[data-node="volumeSort"]').text(_params.newVolumeName);
            $popup.find('[data-node="volumeTitleInput"]').val('');
            $popup.find('[data-node="volumeDescInput"]').val('');
            _maskByCreateVolumePopup.open();
        }
    }

    function closeCreateVolumePopup() {
        if (_maskByCreateVolumePopup) {
            _maskByCreateVolumePopup.close();
        }
    }

    function _refreshCurrentPage() {
        location.href = location.href;
    }

    function _checkVolumeInfo(volumename, volumedesc) {
        volumename = $.trim(volumename);
        volumedesc = $.trim(volumedesc);
        if (volumename.length > 20) {
            _dialog.alert('请输入最多20字作为卷名称!');
            return false;
        }
        if (volumedesc.length > 140) {
            _dialog.alert('请输入最多140字介绍该分卷!');
            return false;
        }
        return true;
    }

    function submitVolume(options) {
        if (!options) {
            return;
        }
        options = $.extend({
            'bookId': _params.bookId || 0,
            'type': 'update',
            'isVip': _params.isVipNovel || -1,
            'volumeName': '',
            'volumeDesc': '',
            'volumeId': 0,
            'alertType': 'topTip',
            'successCallback': function () {
            }
        }, options);
        if (options.type !== 'delete') {
            var isPass = _checkVolumeInfo(options.volumeName, options.volumeDesc);
            if (!isPass) {
                return;
            }
        }
        if (_isSubmitting) {
            return;
        }
        _isSubmitting = 1;
        var alertTip = _topTip.show;
        if (options.alertType === 'alert') {
            alertTip = _dialog.alert;
        }
        _util.request({
            url: _ajaxUrls.submitVolume,
            data: {
                'CBID': options.bookId,
                'type': options.type,
                'CVID': options.volumeId,
                'isvip': options.isVip,
                'volumename': options.volumeName,
                'volumedesc': options.volumeDesc,
                '__hash__': $('input[name="__hash__"]').val()
            },
            type: 'post',
            dataType: "json",
            success: function (json) {
                if (!json) {
                    return;
                }
                if (json.status) {
                    closeCreateVolumePopup();
                    alertTip(json.info || '操作成功', function () {
                        if (typeof options.successCallback === 'function') {
                            options.successCallback();
                        }
                    });
                }
            },
            complete: function () {
                _isSubmitting = 0;
            }
        });
    }

    _util.initNameSpace("CS.page.bookManage");
    CS.page.bookManage.volume = {
        'init': init,
        'submitVolume': submitVolume,
        'openCreateVolumePopup': openCreateVolumePopup
    };
})(jQuery);
(function ($) {
    var _util = CS.util, _mask = CS.mask, _dialog = CS.dialog, _topTip = CS.topTip, _volume = null;
    var _params = {};
    var _isLoading = 0, _isSubmitting = 0, _currentChapterData = {}, _currentVolumeData = {}, _hasPortamento = 0,
        _blackColor = '#333', _createChapter = null, maskConfirm = null, isFineLayoutContent = -1;
    var _chapterTypeName = {'-1': '公众章节', '1': 'VIP章节', '2': '章节感言'};
    var fineLayoutType = {'-1': -1, 1: 1, 2: 2}
    var _ajaxUrls = {
        'getChapterInfo': '/Contentv2/Booknovels/ajaxGetchapter.html',
        'getVolumeInfo': '/Contentv2/Booknovels/ajaxGetVolume.html',
        'getWords': '/Contentv2/Booknovels/ajaxGetwords.html',
        'addGuidedLog': '/Contentv2/Authors/addGuideBookLog.html',
        'addGuideVolumeLog': '/Contentv2/Authors/addGuideVolumeLog.html',
        'deleteChapter': '/Contentv2/Booksubmit/ajaxChapterDel.html',
        'canApplyChapterInfo': '/Contentv2/Booknovels/canApplyChapterInfo.html',
        'addUnblockChapter': '/Contentv2/Booknovels/addUnblockChapter.html',
    };
    var _isTipByExitEdit = 0, _tipByExitEdit = "您编辑的章节内容尚未保存，确定要离开吗？";

    function init(bookId, isVipNovel, newVolumeName, isGuide, isGuideVolume, isAddChapterUrl, allchapter, _tinymce) {
        _params.bookId = bookId || 0;
        _params.isVipNovel = isVipNovel || -1;
        _params.newVolumeName = newVolumeName || '新建分卷';
        _params.isGuide = isGuide || 0;
        _params.isGuideVolume = isGuideVolume || 0;
        _params.isAddChapterUrl = isAddChapterUrl || 0;
        _params.allchapter = allchapter || 0;
        _params._tinymce = _tinymce || '', _createChapter = CS.page.tinymce.create_chapter;
        _volume = CS.page.bookManage.volume;
        _setTipByRefreshPage();
        setTimeout(_setGuide, 200);
        _bindEvent();
        _bindEventByChapterList();
        _bindEventByEditChapter();
        _bindEventByEditVolume();
        _bindEventBySlimScroll();
        _bindEventByBubble();
        _renderRecentChapter();
        _apply_box();
    }

    function _renderRecentChapter() {
        var $chapterList = $('#chapterList'), $recentChapter = $chapterList.find('[data-node="chapterItem"]').eq(0),
            chapterId = $recentChapter.attr('data-chapterid');
        if (chapterId) {
            var $chapterItemList = $recentChapter.parent();
            $chapterItemList.show();
            $recentChapter.addClass('act');
            _getChapterInfo(chapterId);
        }
    }

    function _setGuide() {
        if (_params.isGuide) {
            var $mask = $('#mask');
            $mask.appendTo(document.body).show();
            $mask.on('click', _guideCallback);
            $(window).joyride({'postRideCallback': _guideCallback});
        }
        if (_params.isGuideVolume) {
            $('.minTipBox .close').click(function () {
                $(this).parent('.minTipBox').hide();
                _util.request({
                    url: _ajaxUrls.addGuideVolumeLog,
                    data: {},
                    type: 'post',
                    isShowLoading: false,
                    dataType: "json"
                });
            });
        }
    }

    function _guideCallback() {
        $('#mask').hide();
        $('.joyride-close-tip').parent().hide();
        _util.request({url: _ajaxUrls.addGuidedLog, data: {}, type: 'post', isShowLoading: false, dataType: "json"});
    }

    function _bindEvent() {
        $('#editChapterBtn').on('click', function (event) {
            event.preventDefault();
            _editChapter(_currentChapterData);
        });
        $('#deleteChapterBtn').on('click', function (event) {
            event.preventDefault();
            if (_params.allchapter == 1) {
                _dialog.confirm("删除该章后作品将会被自动屏蔽，确认删除吗？", function () {
                    _deleteChapter(_currentChapterData.CCID);
                });
            } else {
                _deleteChapter(_currentChapterData.CCID);
            }
        });
        $('#editVolumeBtn').on('click', function (event) {
            event.preventDefault();
            _editVolume(_currentVolumeData);
        });
    }

    function _bindEventBySlimScroll() {
        $('#chapterList').slimScroll({
            height: '740px',
            disableFadeOut: true,
            railVisible: true,
            size: '10px',
            wheelStep: 10,
            borderRadius: 0,
            railBorderRadius: 0,
            allowPageScroll: true,
            alwaysVisible: false,
            distance: '-1px'
        });
        $('#sectionText').slimScroll({
            height: '640px',
            disableFadeOut: true,
            railVisible: true,
            alwaysVisible: false,
            borderRadius: 0
        });
        $('#authorSpeak').slimScroll({height: '81px', disableFadeOut: true, railVisible: true, borderRadius: 0});
    }

    function _bindEventByBubble() {
        $('#chapterListWrap').append('<div id="sectionBubble" class="section-bubble"><p></p><span class="icon"></span></div>');
        var $sectionList = $('#chapterList'), $sectionBubble = $('#sectionBubble'),
            $bubbleText = $sectionBubble.find('p');
        $sectionList.on('mouseover', '.sub-volume, .sectionBox p em', function () {
            var $this = $(this), scrollWidth = $this.get(0).scrollWidth, offsetWidth = $this.width();
            if (offsetWidth === scrollWidth) {
                return;
            }
            var txtPos = $this.position(), bubbleTop = txtPos.top, bubbleLeft = txtPos.left;
            $bubbleText.text($this.text());
            $sectionBubble.css({top: bubbleTop + 115 + 'px', left: bubbleLeft + 'px'}).show();
        });
        $sectionList.on('mouseout', '.sub-volume, .sectionBox p em', function () {
            $sectionBubble.hide();
        });
    }

    function _bindEventByChapterList() {
        var $chapterList = $('#chapterList'), $volumeItems = $chapterList.find('[data-node="volumeItem"]'),
            $chapterItemList = $chapterList.find('[data-node="chapterItemList"]'),
            $chapterItems = $chapterList.find('[data-node="chapterItem"]');
        $chapterList.on('click', '[data-node="volumeItem"]', function () {
            var $el = $(this);
            if ($el.hasClass('act')) {
                $el.next('[data-node="chapterItemList"]').slideUp(300);
                $el.removeClass('act');
            } else {
                _confirmExitEdit(function () {
                    var $currentChapterBox = $el.next('[data-node="chapterItemList"]');
                    if ($currentChapterBox.is(':hidden')) {
                        $chapterItemList.slideUp(300);
                        $el.next('[data-node="chapterItemList"]').slideDown(300);
                    }
                    $volumeItems.removeClass('act');
                    $chapterItems.removeClass('act');
                    $el.addClass('act');
                    _getVolumeInfo($el.attr('data-volumeid'));
                });
            }
        });
        $chapterList.on('click', '[data-node="chapterItem"]', function () {
            var $el = $(this);
            _confirmExitEdit(function () {
                $el.addClass('act').siblings().removeClass('act');
                $volumeItems.removeClass('act');
                _getChapterInfo($el.attr('data-chapterid'));
            });
        });
        $('#createVolumeBtn, #createVolumeIconBtn').on('click', function () {
            $chapterList.find('li').removeClass('act');
            _confirmExitEdit(_editVolume);
            return false;
        });
    }

    function _bindEventByEditChapter() {
        var $chapterContentInput = $('#chapterContentInput');
        $('#chapterTitleInput, #chapterContentInput, #authorSpeakInput').on('focus', function (event) {
            event.preventDefault();
            _focusIn($(this));
        }).on('blur', function (event) {
            event.preventDefault();
            _focusOut($(this));
        });
        $('#checkContentWordsBtn').on('click', function (event) {
            event.preventDefault();
            if (isFineLayoutContent == 1) {
                setFormContent();
            }
            _getWords($chapterContentInput.val());
        });
        $('#saveChapterBtn').on('click', function (event) {
            event.preventDefault();
            if (!checkImgAndVideo()) {
                return false;
            }
            if (!checkImgSrc()) {
                return false;
            }
            if (isFineLayoutContent == 1) {
                setFormContent();
            }
            if (_checkChapterInfo()) {
                _saveChapter();
            }
        });
    }

    function checkImgSrc() {
        if (isFineLayoutContent == 1 && !_createChapter.checkImgSrc()) {
            return false;
        }
        return true;
    }

    function checkImgAndVideo() {
        if (isFineLayoutContent == 1 && _createChapter.checkImgCount() > _createChapter.imgMaxNum) {
            _topTip.show(_createChapter.imgError);
            return false;
        } else if (isFineLayoutContent == 1 && _createChapter.checkTXSPCount() > _createChapter.TXSPMaxNum) {
            _topTip.show(_createChapter.videoError);
            return false;
        }
        return true;
    }

    function _bindEventByEditVolume() {
        var $volumeTitleInput = $('#volumeTitleInput'), $volumeDescInput = $('#volumeDescInput');
        $('#saveVolumeBtn').on('click', function () {
            var type = $(this).attr('data-type'), isVip = _params.isVipNovel, volumeName = $volumeTitleInput.val(),
                volumeDesc = $volumeDescInput.val(), volumeId = 0;
            if (type === 'update') {
                isVip = _currentVolumeData.isvip;
                volumeId = _currentVolumeData.CVID;
            } else if (type === 'add') {
                volumeId = $('#chapterList').find('[data-node="volumeItem"]:first').attr('data-volumeid') || 0;
            }
            _volume.submitVolume({
                'bookId': _params.bookId,
                'type': type,
                'isVip': isVip,
                'volumeName': volumeName,
                'volumeDesc': volumeDesc,
                'volumeId': volumeId,
                'alertType': 'topTip',
                'successCallback': _refreshCurrentPage
            });
            return false;
        });
        $('#deleteVolumeBtn').on('click', function () {
            _dialog.confirm('确定要删除该卷吗？', function () {
                _volume.submitVolume({
                    'bookId': _params.bookId,
                    'type': 'delete',
                    'isVip': _currentVolumeData.isvip,
                    'volumeId': _currentVolumeData.CVID,
                    'alertType': 'topTip',
                    'successCallback': _refreshCurrentPage
                });
            });
            return false;
        });
    }

    function _viewChapter(data) {
        if (!data) {
            return;
        }
        var $chapterContainer = $('#chapterContainer'), $viewChapterBox = $('#viewChapterBox'),
            $btnBox = $('#viewChapterBtnBox');
        $viewChapterBox.find('[data-node="chapterTypeName"]').text(_chapterTypeName[data.chaptertype]);
        $('#chapterTitle').text(data.chaptertitle || '');
        if (isFineLayoutContent == 1) {
            $('#chapterContent').html(data.content || '');
        } else {
            $('#chapterContent').html(data.chapterContentFormat || '');
        }
        $('#authorSpeak').html(data.chapterExtraFormat || '');
        $('#volumeContainer').hide();
        $('#editChapterBox').hide();
        $viewChapterBox.show();
        $chapterContainer.show();
        if ($btnBox.attr('data-slide') !== '1') {
            $btnBox.attr('data-slide', '1');
            $btnBox.portamento({'wrapper': $chapterContainer, 'disableWorkaround': true, 'gap': 0});
        }
    }

    function _editChapter(data) {
        if (!data) {
            return;
        }
        _setTipByExitEdit();
        $('#chapterIdHidden').val(data.CCID);
        var $chapterContainer = $('#chapterContainer'), $editChapterBox = $('#editChapterBox'),
            $titleInput = $('#chapterTitleInput'), $contentInput = $('#chapterContentInput'),
            $speakInput = $('#authorSpeakInput'), $editChapterBtnBox = $('#editChapterBtnBox'),
            $tinyMCE_wrap = $('.tinyMCE-wrap');
        $titleInput.val(data.chaptertitle || $titleInput.attr('data-default'));
        var finelayouttype = data.finelayouttype;
        if (finelayouttype == fineLayoutType[1]) {
            $('#mceu_12').show();
            $tinyMCE_wrap.show();
            $contentInput.hide();
            _params._tinymce.activeEditor.setContent(data.content);
        } else if (finelayouttype == fineLayoutType[2]) {
            $tinyMCE_wrap.show();
            $contentInput.hide();
            $('#mceu_12').hide();
            _params._tinymce.activeEditor.setContent(data.content);
        } else {
            $tinyMCE_wrap.hide();
            $contentInput.show();
            $contentInput.val(data.content || $contentInput.attr('data-default'));
        }
        $speakInput.val(data.chapterextra || $speakInput.attr('data-default'));
        $.each([$titleInput, $contentInput, $speakInput], function (index, $el) {
            if ($el.val() === $el.attr('data-default')) {
                $el.css('color', '');
            } else {
                $el.css('color', _blackColor);
            }
        });
        if (data.vipflag > 0 && !data.ismodifytitle) {
            $titleInput.attr('readonly', 'readonly').css('color', '');
        } else {
            $titleInput.removeAttr('readonly');
        }
        $editChapterBox.find('[data-node="chapterTypeName"]').text(_chapterTypeName[data.chaptertype]);
        $('#volumeContainer').hide();
        $('#viewChapterBox').hide();
        $editChapterBox.show();
        $chapterContainer.show();
        if ($editChapterBtnBox.attr('data-slide') !== '1') {
            $editChapterBtnBox.attr('data-slide', '1');
            $editChapterBtnBox.portamento({'wrapper': $chapterContainer, 'disableWorkaround': true, 'gap': 0});
        }
    }

    function _viewVolume(data) {
        var $volumeContainer = $('#volumeContainer'), $viewVolumeBox = $('#viewVolumeBox'),
            $viewVolumeEditBox = $('#viewVolumeEdit'), $btnBox = $('#viewVolumeBtnBox'),
            $contentBox = $viewVolumeBox.find('[data-node="contentBox"]'),
            $viewContentBox = $viewVolumeBox.find('[data-node="viewContentBox"]');
        $viewVolumeBox.find('[data-node="volumeSortName"]').text(data.volumeSortName);
        $viewVolumeBox.find('[data-node="chapterCount"]').text(data.volumechapters);
        $('#volumeTitle').text(data.volumename);
        $('#volumeDesc').text(data.volumedesc);
        if (data.volumetype === '0') {
            $viewVolumeEditBox.hide();
            $contentBox.hide();
            $viewContentBox.hide();
        } else {
            $viewVolumeEditBox.show();
            $viewContentBox.show();
            $contentBox.show();
        }
        $('#chapterContainer').hide();
        $('#editVolumeBox').hide();
        $viewVolumeBox.show();
        $volumeContainer.show();
        if ($btnBox.attr('data-slide') !== '1') {
            $btnBox.attr('data-slide', '1');
            $btnBox.portamento({'wrapper': $volumeContainer, 'disableWorkaround': true, 'gap': 0});
        }
    }

    function _editVolume(data) {
        var $volumeContainer = $('#volumeContainer'), $editVolumeBox = $('#editVolumeBox'),
            $volumeSortName = $editVolumeBox.find('[data-node="volumeSortName"]'),
            $chapterCountBox = $editVolumeBox.find('[data-node="chapterCountBox"]'),
            $chapterCount = $editVolumeBox.find('[data-node="chapterCount"]'),
            $volumeTitleInput = $('#volumeTitleInput'), $volumeDescInput = $('#volumeDescInput'),
            $saveVolumeBtn = $('#saveVolumeBtn'), $contentBox = $editVolumeBox.find('[data-node="contentBox"]');
        _cancelTipByExitEdit();
        if (data) {
            $volumeSortName.text(data.volumeSortName);
            $chapterCount.text(data.volumechapters);
            $chapterCountBox.show();
            $volumeTitleInput.val(data.volumename);
            $volumeDescInput.val(data.volumedesc);
            $saveVolumeBtn.attr('data-type', 'update');
            if (data.volumesort === '0') {
                $contentBox.hide();
            } else {
                $contentBox.show();
            }
        } else {
            $volumeSortName.text(_params.newVolumeName);
            $chapterCountBox.hide();
            $volumeTitleInput.val('');
            $volumeDescInput.val('');
            $saveVolumeBtn.attr('data-type', 'add');
            $('#chapterCountView').text('');
            $contentBox.show();
        }
        $('#chapterContainer').hide();
        $('#viewVolumeBox').hide();
        $editVolumeBox.show();
        $volumeContainer.show();
    }

    function _getChapterInfo(CCID) {
        if (!CCID) {
            return;
        }
        if (_isLoading) {
            return;
        }
        _isLoading = 1;
        _util.request({
            url: _ajaxUrls.getChapterInfo,
            data: {'CBID': _params.bookId, 'CCID': CCID},
            type: 'post',
            dataType: "json",
            success: function (json) {
                if (!json) {
                    return;
                }
                if (json.status && json.data) {
                    _currentChapterData = json.data;
                    if (_currentChapterData.finelayouttype == 1 || _currentChapterData.finelayouttype == 2) {
                        isFineLayoutContent = 1;
                    }
                    if (_currentChapterData.status == 4) {
                        $("#applyChapterBan").show();
                    } else {
                        $("#applyChapterBan").hide();
                    }
                    _viewChapter(_currentChapterData);
                    _cancelTipByExitEdit();
                }
            },
            complete: function () {
                _isLoading = 0;
            }
        });
    }

    function _getVolumeInfo(CVID) {
        if (!CVID) {
            return;
        }
        if (_isLoading) {
            return;
        }
        _isLoading = 1;
        _util.request({
            url: _ajaxUrls.getVolumeInfo,
            data: {'CBID': _params.bookId, 'CVID': CVID},
            type: 'post',
            dataType: "json",
            success: function (json) {
                if (!json) {
                    return;
                }
                if (json.status) {
                    _currentVolumeData = json.data;
                    _viewVolume(json.data);
                } 
            },
            complete: function () {
                _isLoading = 0;
            }
        });
    }

    function _getWords(content) {
        if (content) {
            content = $.trim(content);
        }
        if (!content || content === $('#chapterContentInput').attr('data-default')) {
            _dialog.alert('字数为：0');
            return;
        }
        if (_isLoading) {
            return;
        }
        _isLoading = 1;
        _util.request({
            url: _ajaxUrls.getWords,
            data: {'content': content},
            type: 'post',
            dataType: "json",
            success: function (json) {
                if (!json) {
                    _topTip.show('返回的数据格式异常，请稍候再试');
                    return;
                }
                if (json.status) {
                    if ('data' in json) {
                        _dialog.alert('字数为：' + json.data);
                    }
                } 
            },
            complete: function () {
                _isLoading = 0;
            }
        });
    }

    function _saveChapter() {
        if (_isSubmitting) {
            return;
        }
        _isSubmitting = 1;
        _util.ajaxSubmitForm($('#formChapter'), {
            type: "POST", data: {'_token': $.cookie('pubtoken')}, dataType: "json", success: function (json) {
                if (!json) {
                    _topTip.show('返回的数据格式异常，请稍候再试');
                    return;
                }
                if (json.status) {
                    _topTip.show(json.info || '保存成功', function () {
                        _cancelTipByExitEdit();
                        var __chapterIdHidden = $('#chapterIdHidden').val();
                        $("#chapterListWrap li[data-chapterid='" + __chapterIdHidden + "'] div p em").html($("#chapterTitleInput").val());
                        $("#chapterListWrap li[data-chapterid='" + __chapterIdHidden + "']").click();
                    });
                } 
            },  complete: function () {
                _isSubmitting = 0;
            }
        });
    }

    function _checkChapterInfo() {
        var $chapterTitleInput = $('#chapterTitleInput'), $chapterContentInput = $('#chapterContentInput'),
            $authorSpeakInput = $('#authorSpeakInput');
        var chaptertitle = $.trim($chapterTitleInput.val()), content = $chapterContentInput.val(),
            authorSpeak = $authorSpeakInput.val();
        if (chaptertitle.length === 0 || chaptertitle === $chapterTitleInput.attr('data-default')) {
            _dialog.alert('请输入章节名称');
            $chapterTitleInput.focus();
            return false;
        }
        if (chaptertitle.length > 35) {
            _dialog.alert('请输入35字以内作为章节名称');
            $chapterTitleInput.focus();
            return false;
        }
        if (content.length === 0 || content === $chapterContentInput.attr('data-default')) {
            _dialog.alert('请输入正文');
            $chapterContentInput.focus();
            return false;
        }
        if (authorSpeak === $authorSpeakInput.attr('data-default')) {
            authorSpeak = '';
            $authorSpeakInput.val('');
        }
        if (authorSpeak.length > 500) {
            _dialog.alert('作者的话不可超过500字');
            $authorSpeakInput.focus();
            return false;
        }
        return true;
    }

    function _checkChapterIsModified() {
        var isModified = false;
        var $chapterTitleInput = $('#chapterTitleInput'), $chapterContentInput = $('#chapterContentInput'),
            $authorSpeakInput = $('#authorSpeakInput');
        if (isFineLayoutContent == 1) {
            $chapterContentInput.val(_params._tinymce.activeEditor.getContent());
        }
        var list = [{
            'userInput': $chapterTitleInput.val(),
            'defaultInput': $chapterTitleInput.attr('data-default'),
            'original': _currentChapterData.chaptertitle
        }, {
            'userInput': $chapterContentInput.val(),
            'defaultInput': $chapterContentInput.attr('data-default'),
            'original': _currentChapterData.content
        }, {
            'userInput': $authorSpeakInput.val(),
            'defaultInput': $authorSpeakInput.attr('data-default'),
            'original': _currentChapterData.chapterextra
        }];
        $.each(list, function (index, item) {
            if (item.userInput !== item.original && item.userInput !== item.defaultInput) {
                isModified = true;
                return false;
            }
        });
        return isModified;
    }

    function _deleteChapter(CCID) {
        if (!CCID) {
            return;
        }
        if (_isSubmitting) {
            return;
        }
        _isSubmitting = 1;
        _util.request({
            url: _ajaxUrls.deleteChapter,
            type: 'post',
            dataType: 'json',
            data: {'CBID': _params.bookId, 'CCID': CCID},
            success: function (json) {
                if (!json) {
                    _topTip.show('返回数据格式异常，请稍后再试');
                    return;
                }
                if (json.status) {
                    _topTip.show(json.info || '删除成功', function () {
                        _cancelTipByExitEdit();
                        _refreshCurrentPage();
                    });
                } 
            },
            complete: function () {
                _isSubmitting = 0;
            }
        });
    }

    function _setTipByRefreshPage() {
        window.onbeforeunload = function () {
            if (!_isTipByExitEdit || !_checkChapterIsModified()) {
                return;
            }
            var tips = _tipByExitEdit;
            if (document.all) {
                if (event.clientX > document.body.clientWidth || event.clientY < 0 || event.altKey || event.ctrlKey) {
                    return tips;
                } else {
                    return tips;
                }
            } else {
                return tips;
            }
        };
    }

    function _confirmExitEdit(exitFn) {
        if (typeof exitFn !== 'function') {
            exitFn = function () {
            };
        }
        if (_isTipByExitEdit && _checkChapterIsModified()) {
            _dialog.confirm(_tipByExitEdit, exitFn);
        } else {
            exitFn();
        }
    }

    function _setTipByExitEdit() {
        _isTipByExitEdit = 1;
    }

    function _cancelTipByExitEdit() {
        _isTipByExitEdit = 0;
    }

    function _refreshCurrentPage() {
        location.href = location.href;
    }

    function _focusIn($el) {
        if ($el.attr('readonly')) {
            return;
        }
        if ($el.val() === $el.attr('data-default')) {
            $el.val('');
        }
        $el.css('color', _blackColor);
    }

    function _focusOut($el) {
        if ($el.attr('readonly')) {
            return;
        }
        if ($el.val() === '') {
            $el.val($el.attr('data-default')).css('color', '');
        }
    }

    function setFormContent() {
        $("#chapterContentInput").val(_params._tinymce.activeEditor.getContent());
    }

    function _apply_box() {
        maskConfirm = new _mask($('#apply_chapter_box'));
        $("#applyChapterBan").on('click', function () {
            var CCID = _currentChapterData.CCID;
            var CBID = _params.bookId;
            $('.error-tip').text("");
            _can_apply_chapter(CCID, CBID);
        });
        $('.sideBar li').on('click', function () {
            $(this).addClass('act').siblings().removeClass();
        });
        $('.confirmBtn .cancal, .closePopup').on('click', function () {
            maskConfirm.close();
            $(this).closest('#apply_chapter_box').hide();
        });
        $('.confirmBtn .ok').on('click', function () {
            var CBID = _params.bookId;
            var content = $('#clearText').val();
            var CCID = _currentChapterData.CCID;
            _apply_chapter_Ban(CCID, CBID, content);
        });
    }

    function _can_apply_chapter(CCID, CBID) {
        if (_isSubmitting) {
            return false;
        }
        _isSubmitting = 1;
        _util.request({
            url: _ajaxUrls.canApplyChapterInfo,
            type: 'post',
            dataType: 'json',
            data: {"CBID": CBID, 'CCID': CCID},
            success: function (json) {
                if (!json) {
                    _dialog.alert('返回数据异常，请稍候再试');
                    return;
                }
                if (json.code == 200) {
                    $("#lockTime").text(json.data)
                    $('#clearText').val("");
                    maskConfirm.open();
                    $('#apply_chapter_box').removeClass('hidden');
                    return;
                } else {
                    _dialog.alert(json.info);
                    return;
                }
            },
            complete: function () {
                _isSubmitting = 0;
            }
        });
    }

    function _apply_chapter_Ban(CCID, CBID, content) {
        if (!_check_conent_num(content)) {
            $('.error-tip').text("申诉内容请控制在1-500个字");
            return false;
        }
        if (_isSubmitting) {
            return false;
        }
        _isSubmitting = 1;
        _util.request({
            url: _ajaxUrls.addUnblockChapter,
            type: 'post',
            dataType: 'json',
            data: {"CBID": CBID, 'CCID': CCID, "content": content},
            success: function (json) {
                if (!json) {
                    $('.error-tip').text("返回数据异常，请稍候再试");
                    return;
                }
                if (json.code == 200) {
                    $('.error-tip').text("提交成功");
                    $('#clearText').val("");
                    $('.confirmBtn .cancal').click();
                    _dialog.alert('提交成功');
                    return;
                } else {
                    $('.error-tip').text(json.info);
                    return;
                }
            },
            complete: function () {
                _isSubmitting = 0;
            }
        });
    }

    function _check_conent_num(content) {
        var num = content.length;
        if (num <= 0 || num > 500) {
            return false;
        }
        return true;
    }

    _util.initNameSpace("CS.page.bookManage");
    CS.page.bookManage.chapterManage = {'init': init};
})(jQuery);
(function ($) {
    var _util = CS.util, _uiBinder = CS.uiBinder, _mask = CS.mask, _topTip = CS.topTip, _dialog = CS.dialog,
        _localImg = CS.localImg, _volume = null, _createChapter = null;
    var _params = {}, _nodes = {}, _isSubmitting = 0, _maskCreateRolePopup = null, _maskRoleManagePopup = null,
        _maskRoleDeletePopup = null, _countRoleDeletePopup = 0, _countRoleManagePopup = 0, _countCreateRolePopup = 0,
        _countBirthday = 0;
    var _ajaxUrls = {
        'ajaxGetRoleNum': '/Contentv2/Rolemanage/ajaxGetRoleNum.html',
        'ajaxAddRole': '/Contentv2/Rolemanage/ajaxAddRole.html',
        'ajaxUpdateRole': '/Contentv2/Rolemanage/ajaxUpdateRole.html',
        'ajaxDelRole': '/Contentv2/Rolemanage/ajaxDelRole.html',
        'ajaxListRole': '/Contentv2/Rolemanage/ajaxListRole.html',
        'ajaxGetRoleInfo': '/Contentv2/Rolemanage/ajaxGetRoleInfo.html',
        'ajaxGetConstellation': '/Contentv2/Rolemanage/ajaxGetConstellation.html'
    };
    var _roleManageTpl = ['<li>', '<div class="content">', '<div class="avatar"><img src="<%=roleInfo.cfmportrait%>"></div>', '<div class="info">', '<div class="text">', '<h3><%=roleInfo.nickname%><span><%=roleInfo.nametype%></span></h3>', '<p><%=roleInfo.cfmremark%></p>', '</div>', '<i></i>', '</div>', '<div class="btn-box">', '<input type="hidden" value="<%=roleInfo.CRID%>">', '<a class="editRole" href="javascript:">编辑</a>', '<a class="delRole" href="javascript:">删除</a>', '</div>', '</div>', '</li>'].join('');

    function init(CBID) {
        _params.CBID = CBID;
        _params.jmoreBtn_click_num = 0;
        _nodes.$createRolePopup = $('#createRolePopup');
        _nodes.$roleManagePopup = $('#roleManagePopup');
        _nodes.$roleDeletePopup = $('#roleDeletePopup');
        _nodes.$jcharacterList = $('#j-characterList');
        _nodes.$jinsertStart = $('#j-insertStart');
        _nodes.$insertEnd = $('#insertEnd');
        _nodes.$roleId = $('#roleId');
        _bindEventDialog();
        _bindDialogLoad();
        _allCharacterListShow();
        _jcharacterListSroll()
        _jAllCharacterList();
        _changeMonth();
        _changeDate();
    }

    function _bindEventDialog() {
        _bindFileImg('acUpload', 'roleImg');
        $("#createRole,.add-character").on('click', function () {
            $("#createRolePopup .popup-title").find('h3').html("创建角色");
            $("#createRolePopup").find('label[for="acUpload"]').html("上传头像");
            $("#roleImg").attr("src", default_photo);
            $("#zsjs").parent(".radio").addClass('on');
            $("#zsjs").attr("checked", "checked");
            $("#ycjs").removeAttr('checked');
            $("#ycjs").parent(".radio").removeClass('on');
            $(".create-character-wrap .combo-input").val('请选择角色类型');
            $("#roletype").val(0)
            _params.class_name = $(this).attr("class");
            _showCreateRolePopup();
            _setMonthDate(0, 0);
        });
        $("#bookrolemanage").on('click', function () {
            _showRoleManagePopup();
        });
        $("#roleDeleteConfirm").on('click', function () {
            _roleDeleteSubmit();
        });
        $("#roleCreateConfirm").on('click', function () {
            _roleCreateSubmit();
        });
        _nodes.$createRolePopup.find('[data-node-do-role="close"]').click(function (event) {
            event.preventDefault();
            _closeCreateRolePopup();
            return false;
        })
        _nodes.$roleDeletePopup.find('[data-node-del-role="close"]').click(function (event) {
            event.preventDefault();
            _closeRoleDelPopup();
            return false;
        })
        _nodes.$roleManagePopup.find('[data-node-man-role="close"]').click(function (event) {
            event.preventDefault();
            _closeRoleManagePopup();
            return false;
        });
    }

    function _bindDialogLoad() {
        $(document).on("click", '.editRole', function (event) {
            event.preventDefault();
            _params.class_name = $(this).attr("class");
            _params.CRID = $(this).siblings("input").val();
            _nodes.$roleContent = $(this).parent('.btn-box').parent('.content');
            _showCreateRolePopup();
        });
        $(document).on("click", '.delRole', function (event) {
            event.preventDefault();
            _params.CRID = $(this).siblings("input").val();
            _nodes.$deleteLi = $(this).parent('.btn-box').parent('.content').parent();
            _showRoleDelPopup();
        });
    }

    function _bindFileImg(fileid, imgid) {
        if ($('#' + fileid).length !== 0) {
            $('#' + fileid).on('change', function () {
                var isSelectedImg = _localImg.showv2($(this), $('#' + imgid), {
                    'imgMaxSize': 2048 * 5,
                    'imgMaxSizeTips': '检测到上传照片超过2MB，请重新上传。',
                    'supportFileTypes': 'jpg|png',
                    'fileTypeErrorTips': '图片格式一定要是JPG，PNG中的一种'
                });
                if (!isSelectedImg) {
                    $('#' + fileid).val('');
                }
            });
        }
    }

    function _allCharacterListShow() {
        var $moreBtn = $('#j-moreBtn'), $characterList = $('#j-AllCharacterList');
        $moreBtn.on('click', function () {
            $characterList.fadeIn(200);
        });
        $(document).on('click', function (e) {
            var target = $(e.target);
            if (target.attr('id') == 'j-moreBtn' || target.closest('#j-AllCharacterList').length > 0 || target.hasClass('more')) {
                return;
            } else {
                $characterList.fadeOut(200);
            }
        })
    }

    function _showCreateRolePopup() {
        var requestData = {'CBID': _params.CBID, 'CRID': _params.CRID || 0};
        if (_isSubmitting == 1) {
            return;
        }
        _isSubmitting = 1;
        _util.request({
            url: (_params.class_name == 'editRole') ? _ajaxUrls.ajaxGetRoleInfo : _ajaxUrls.ajaxGetRoleNum,
            data: requestData,
            type: 'post',
            success: function (json) {
                if (!json) {
                    _dialog.alert('返回数据格式异常，请稍后再试');
                    return;
                }
                if (json.status == false) {
                    _dialog.alert(json.info);
                    return;
                } else {
                    if (!_maskCreateRolePopup) {
                        _maskCreateRolePopup = new _mask(_nodes.$createRolePopup);
                    }
                    if (!_maskCreateRolePopup) {
                        return;
                    }
                    if (_params.class_name == 'editRole') {
                        $("#createRolePopup .popup-title").find('h3').html("编辑角色");
                        $("#createRolePopup").find('label[for="acUpload"]').html("修改头像");
                        $("#roleName").val(json.nickname);
                        $("#roleDesc").val(json.cfmremark);
                        if (json.roleshow_status == -1) {
                            $("#roleshowstatus").prop("checked", "checked");
                        } else {
                            $("#roleshowstatus").removeAttr("checked");
                        }
                        $("#roleImg").attr('src', json.cfmportrait);
                        $("#roletype").val(json.role).change();
                        $("#height").val(json.height);
                        $("#weight").val(json.weight);
                        $("#age").val(json.age);
                        var md = json.birthday.split('/');
                        if (md.length == 2) {
                            month = md[0];
                            date = md[1];
                            $("#birMonth_em").text(month);
                            $("#birDay_em").text(date);
                            $("#constellation_i").text(json.constellation);
                            $("#birthday_select").hide();
                            $("#birthday_text").show();
                        } else {
                            _setMonthDate(0, 0);
                            $("#birthday_select").show();
                            $("#birthday_text").hide();
                        }
                        $(".create-character-wrap .combo-input").val(json.nametype);
                    } else {
                        $("#createRolePopup .popup-title").find('h3').html("创建角色");
                    }
                    _maskCreateRolePopup.open();
                    _isSubmitting = 0;
                }
            },
            complete: function () {
                _isSubmitting = 0;
            }
        });
    }

    function _closeCreateRolePopup() {
        if (_maskCreateRolePopup) {
            _maskCreateRolePopup.close();
            $("#acUpload").val('');
            $("#roleName").val('');
            $("#roleDesc").val('');
            $("#roletype").val("0").change();
            $("#height").val('');
            $("#weight").val('');
            $("#age").val('');
            $("#roleshowstatus").removeAttr("checked");
            $("#birMonth").val(0);
            $("#birDay").val(0);
            $("#birthday_select").show();
            $("#birthday_text").hide();
            _countBirthday = 0;
        }
    }

    function _showRoleManagePopup() {
        var requestData = {'CBID': _params.CBID};
        if (_countRoleManagePopup > 0) {
            return;
        }
        _countRoleManagePopup = 1;
        _util.request({
            url: _ajaxUrls.ajaxListRole, data: requestData, type: 'post', success: function (json) {
                if (!json) {
                    _dialog.alert('返回数据格式异常，请稍后再试');
                    return;
                }
                if (json.length == 0) {
                    _roleEmpty();
                } else {
                    _nodes.$jcharacterList.find("ul li").remove();
                    for (i = 0; i < json.length; i++) {
                        tpl = _uiBinder.bindData(_roleManageTpl, {'roleInfo': json[i]});
                        _nodes.$jcharacterList.find("ul").append(tpl);
                    }
                    _bindDialogLoad();
                    return false;
                }
            }, complete: function () {
                _countRoleManagePopup = 0;
            }
        });
        if (!_maskRoleManagePopup) {
            _maskRoleManagePopup = new _mask(_nodes.$roleManagePopup);
        }
        if (!_maskRoleManagePopup) {
            return;
        }
        _maskRoleManagePopup.open();
        _countRoleManagePopup = 0;
    }

    function _closeRoleManagePopup() {
        if (_maskRoleManagePopup) {
            _maskRoleManagePopup.close();
            _countRoleManagePopup = 0;
        }
    }

    function _showRoleDelPopup() {
        if (_countRoleDeletePopup > 0) {
            return;
        }
        if (!_maskRoleDeletePopup) {
            _maskRoleDeletePopup = new _mask(_nodes.$roleDeletePopup);
        }
        if (!_maskRoleDeletePopup) {
            return;
        }
        _maskRoleDeletePopup.open();
        _countRoleDeletePopup = 1;
    }

    function _closeRoleDelPopup() {
        if (_maskRoleDeletePopup) {
            _maskRoleDeletePopup.close();
            _countRoleDeletePopup = 0;
        }
    }

    function _roleDeleteSubmit() {
        var requestData = {'CBID': _params.CBID, 'CRID': _params.CRID};
        _util.request({
            url: _ajaxUrls.ajaxDelRole, data: requestData, type: 'post', success: function (json) {
                if (!json) {
                    _dialog.alert('返回数据格式异常，请稍后再试');
                    return;
                }
                if (json.status == false) {
                    _dialog.alert(json.info);
                    return;
                } else {
                    _topTip.show(json.info);
                    _nodes.$deleteLi.remove();
                    _delSelectCharacter(_params.CRID);
                    _delAllCharacterList(_params.CRID);
                    _closeRoleDelPopup();
                }
            }
        });
    }

    function _roleCreateSubmit() {
        if (_countBirthday == 1) {
            _dialog.confirm("角色生日一旦填写则不允许修改，是否确认？", function () {
                _roleCreateSubmitSon();
            });
        }
        else {
            _roleCreateSubmitSon();
        }
    }

    function _roleCreateSubmitSon() {
        var roleName = $("#roleName").val();
        var roleDesc = $("#roleDesc").val();
        var roletype = $("#roletype").val();
        var height = $("#height").val();
        var weight = $("#weight").val();
        var age = $("#age").val();
        var birthday = _getBirthday();
        var roleshowStatus = $("#roleshowstatus:checked").val();
        if (roleName.length < 1 || roleName.length > 10) {
            alert('昵称至少一个字，最多不超过10个汉字');
            return;
        }
        if (roleDesc.length > 50) {
            alert('描述至多50个汉字');
            return;
        }
        if (roletype < 1) {
            alert('请选择角色类型');
            return;
        }
        if (height.length > 10) {
            alert('身高不超过10个字');
            return;
        }
        if (weight.length > 10) {
            alert('体重不超过10个字');
            return;
        }
        if (age.length > 10) {
            alert('年龄不超过10个字');
            return;
        }
        if (!_isValidMonthDate()) {
            alert('角色生日请填写完整的日期');
            return;
        }
        var formData = new FormData();
        formData.append("myfile", $("#acUpload")[0].files[0]);
        formData.append("roleName", roleName);
        formData.append("roleDesc", roleDesc);
        formData.append("roletype", roletype);
        formData.append("roleshowStatus", roleshowStatus);
        formData.append("CBID", _params.CBID);
        formData.append("height", height);
        formData.append("weight", weight);
        formData.append("age", age);
        formData.append("birthday", birthday);
        if (_params.class_name == 'editRole') {
            formData.append("CRID", _params.CRID);
        }
        _util.request({
            url: (_params.class_name == 'editRole') ? _ajaxUrls.ajaxUpdateRole : _ajaxUrls.ajaxAddRole,
            data: formData,
            type: 'post',
            processData: false,
            contentType: false,
            cache: false,
            success: function (json) {
                if (!json) {
                    _dialog.alert('返回数据格式异常，请稍后再试');
                    return;
                }
                if (json.status == false) {
                    _dialog.alert(json.info);
                    return;
                } else {
                    _topTip.show(json.info);
                    if (_params.class_name == 'editRole') {
                        _nodes.$roleContent.find('.text h3').html(json.data.nickname + '<span>' + json.data.nametype + '</span>');
                        _nodes.$roleContent.find('.text p').html(json.data.remark);
                        _nodes.$roleContent.find('.avatar img').attr('src', json.data.cfmportrait);
                        _updateAllCharacterList(json.data.CRID, json.data.nickname, json.data.cfmportrait);
                    } else {
                        tpl = _uiBinder.bindData(_roleManageTpl, {'roleInfo': json.data});
                        $("#noData").hide();
                        _nodes.$jcharacterList.find("ul").append(tpl);
                    }
                    _closeCreateRolePopup();
                    return false;
                }
            }
        });
    }

    function _delSelectCharacter(CRID) {
        if (!CRID) {
            return;
        }
        var currentInput = $('#j-selectCharacter input[value="' + CRID + '"]');
        if (currentInput.length == 0) {
            return;
        }
        currentInput.parent().remove();
    }

    function _delAllCharacterList(CRID) {
        if (!CRID) {
            return;
        }
        var currentLi = $('#j-AllCharacterList').find('ul li[crid="' + CRID + '"]');
        if (currentLi.length == 0) {
            return;
        }
        currentLi.remove();
        _doInsertEnd();
    }

    function _updateAllCharacterList(CRID, nickname, cfmportrait) {
        if (!CRID || !nickname || !cfmportrait) {
            return;
        }
        var currentLi = $('#j-AllCharacterList').find('ul li[crid="' + CRID + '"]');
        if (currentLi.length == 0) {
            return;
        }
        currentLi.find('img').attr('src', cfmportrait);
        currentLi.find('cite').html(nickname);
    }

    function _jcharacterListSroll() {
        $('#j-characterList').slimScroll({
            height: '528px',
            railVisible: true,
            size: '8px',
            wheelStep: 8,
            borderRadius: 0,
            railBorderRadius: 0,
            disableFadeOut: true,
            allowPageScroll: false,
            alwaysVisible: false,
            distance: '-1px'
        });
    }

    function _jAllCharacterList() {
        $('#j-AllCharacterList ul').slimScroll({
            height: '247px',
            railVisible: true,
            size: '6px',
            wheelStep: 2,
            borderRadius: 0,
            railBorderRadius: 0,
            disableFadeOut: true,
            allowPageScroll: false,
            alwaysVisible: true,
            distance: '-1px'
        });
    }

    function _roleEmpty() {
        var emptytpl = '<div class="no-data" id="noData"> <div class="no-icon"></div> <p>暂无数据</p> </div>';
        $("#j-characterList").append(emptytpl);
    }

    function _getDates(month) {
        return new Date(2016, month, 0).getDate();
    }

    function _getDateOptions(month, date) {
        var dates = _getDates(month);
        var options = '<option value="0"></option>';
        var selected = '';
        for (var i = 1; i <= dates; i++) {
            if (date == i) {
                selected = "selected";
            }
            tmp = i;
            if (tmp < 10) {
                tmp = '0' + i;
            }
            options += " <option value='" + tmp + "' " + selected + ">" + tmp + "</option>";
            selected = '';
        }
        return options;
    }

    function _getMonthOptions(month) {
        var options = '<option value="0"></option>';
        var selected = '';
        var tmp = '';
        for (var i = 1; i <= 12; i++) {
            if (month == i) {
                selected = "selected";
            }
            tmp = i;
            if (tmp < 10) {
                tmp = '0' + i;
            }
            options += " <option value='" + tmp + "' " + selected + ">" + tmp + "</option>";
            selected = '';
        }
        return options;
    }

    function _setMonthDate(month, date) {
        var monthOptions = _getMonthOptions(month);
        var dateOptions = _getDateOptions(month, date);
        $('#birMonth').html(monthOptions);
        $('#birMonth').comboSelect();
        $('#birDay').html(dateOptions);
        $('#birDay').comboSelect();
        $('#birDay').change();
    }

    function _changeMonth() {
        $('#birMonth').on('change', function () {
            var month = $('#birMonth').val();
            var dateOptions = _getDateOptions(month, 0);
            $('#birDay').html(dateOptions);
            $('#birDay').comboSelect();
            $('#birDay').change();
        });
    }

    function _changeDate() {
        $('#birDay').on('change', function () {
            _getConstellation();
        });
    }

    function _getConstellation() {
        var birthday = _getBirthday();
        if (birthday.length != 5) {
            return;
        }
        _countBirthday = 1;
        var requestData = {'CBID': _params.CBID, 'birthday': birthday};
        _util.request({
            url: _ajaxUrls.ajaxGetConstellation, data: requestData, type: 'post', success: function (json) {
                if (!json) {
                    _dialog.alert('返回数据格式异常，请稍后再试');
                    return;
                }
                if (json.status == false) {
                    _dialog.alert(json.info);
                    return;
                } else {
                    $("#constellation").text(json.data);
                }
            }
        });
    }

    function _getBirthday() {
        var month = $('#birMonth').val();
        var day = $('#birDay').val();
        if (month == 0 || day == 0 || month == null || day == 0) {
            return '';
        }
        return month + '/' + day;
    }

    function _isValidMonthDate() {
        var month = $('#birMonth').val();
        var day = $('#birDay').val();
        if ((month != 0 && day == 0) || (month == 0 && day != 0)) {
            return false;
        }
        return true;
    }

    _util.initNameSpace("CS.page.bookManage");
    CS.page.bookManage.roleMange = {'init': init};
})(jQuery);